name: E2E CI Governance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  pre-flight:
    name: üõ°Ô∏è Pre-flight Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Contract Violation Detector
        run: |
          chmod +x ./backend/scripts/ci-contract-check.sh
          ./backend/scripts/ci-contract-check.sh
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Lint Contract Enforcement
        run: |
          npm run lint || {
            echo "‚ùå LINT CONTRACT VIOLATION: Code does not pass linting."
            exit 1
          }
      
      - name: Type Contract Enforcement
        run: |
          npx tsc --noEmit || {
            echo "‚ùå TYPE CONTRACT VIOLATION: TypeScript compilation errors detected."
            exit 1
          }
      
      - name: Source Integrity Check
        run: |
          chmod +x ./backend/scripts/ci-preflight.sh
          ./backend/scripts/ci-preflight.sh

  build:
    name: üèóÔ∏è Global Build Contract
    needs: pre-flight
    runs-on: ubuntu-latest
    env:
      # CI build environment - prevent Supabase network calls during SSR
      CI: true
      SUPABASE_DISABLED: true
      NEXT_PUBLIC_SUPABASE_URL: https://mock.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: mock-anon-key
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: ci-build-secret-key-for-testing
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Build Contract Enforcement
        run: |
          npm run build || {
            echo "‚ùå BUILD CONTRACT VIOLATION: 'npm run build' failed."
            echo "   E2E tests CANNOT run until build succeeds."
            exit 1
          }
          
          if [ ! -d "frontend/.next" ]; then
            echo "‚ùå BUILD CONTRACT VIOLATION: frontend/.next directory not created."
            echo "   Build appeared to succeed but output is missing."
            exit 1
          fi
          
          # Verify frontend/.next has actual content
          NEXT_SIZE=$(du -s frontend/.next | cut -f1)
          if [ "$NEXT_SIZE" -lt 1000 ]; then
            echo "‚ùå BUILD CONTRACT VIOLATION: frontend/.next directory is suspiciously small ($NEXT_SIZE KB)"
            ls -la frontend/.next/
            exit 1
          fi
          
          echo "‚úÖ Build contract satisfied. Artifact size: $NEXT_SIZE KB"
      
      - name: Package Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: |
            frontend/.next/
            frontend/public/
            package.json
            package-lock.json
            frontend/next.config.mjs
            playwright.config.ts
          retention-days: 1
          include-hidden-files: true

  test:
    name: üß™ E2E Suite (${{ matrix.project }})
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        project: [chromium, mobile-chrome, tablet]
    
    env:
      # Global env for all steps in this job
      CI: true
      PORT: 3001
      NODE_ENV: production
      SUPABASE_DISABLED: true
      NEXTAUTH_URL: http://localhost:3001
      NEXTAUTH_SECRET: UDQ0C5vC8y9LpuALAFij+g7LzQWlkXCd6jiwNJtcI6g=
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # CRITICAL: Install ALL dependencies first (including Playwright)
      - name: Install All Dependencies
        run: npm ci
      
      # CRITICAL: Install browsers BEFORE any Next.js operations
      - name: Playwright Browser Contract
        run: |
          echo "üì¶ Installing Playwright browsers..."
          npx playwright install chromium webkit --with-deps
          echo "‚úÖ Playwright browsers installed."
      
      - name: Restore Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: next-build
          # Download to workspace root - artifact preserves directory structure

      - name: Verify Build Artifacts
        run: |
          if [ ! -d "frontend/.next" ]; then
            echo "‚ùå ARTIFACT ERROR: frontend/.next directory missing after download"
            ls -la
            exit 1
          fi
          echo "‚úÖ Build artifacts restored successfully"
          ls -la frontend/.next/
      
      - name: Start Application (Isolation Contract)
        run: |
          # Enforce PORT 3001 for E2E isolation
          PORT=3001 npx next start frontend &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Verify process started
          sleep 3
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "‚ùå ISOLATION CONTRACT VIOLATION: Server process failed to start."
            exit 1
          fi
          
          echo "‚úÖ Server started (PID: $SERVER_PID)"

      - name: Readiness Contract Enforcement
        run: |
          chmod +x ./backend/scripts/wait-for-app.sh
          ./backend/scripts/wait-for-app.sh http://localhost:3001/api/health 120 || {
            echo "‚ùå READINESS CONTRACT VIOLATION: Application did not signal readiness."
            echo "   /api/health must respond within 120 seconds."
            exit 1
          }

      - name: Mandatory Guardrail Check
        run: |
          READY_SIGNAL=$(curl -s http://localhost:3001/api/health)
          
          if [[ ! "$READY_SIGNAL" == *"\"ready\":true"* ]]; then
            echo "‚ùå READINESS CONTRACT VIOLATION: Invalid health response."
            echo "   Expected: {\"ready\": true}"
            echo "   Received: $READY_SIGNAL"
            exit 1
          fi
          
          echo "‚úÖ Guardrail passed. Application ready for E2E tests."

      - name: Determinism Contract Check
        run: |
          # Verify no external dependencies are reachable unless mocked
          echo "‚úÖ Determinism: All external calls should use local mocks or fixtures."
          # Add specific checks here if needed (e.g., network isolation)

      - name: Run Complete E2E Suite
        run: |
          npx playwright test --project=${{ matrix.project }} || {
            echo "‚ùå E2E TESTS FAILED for ${{ matrix.project }}"
            exit 1
          }
        env:
          CI: true
          PORT: 3001
          SUPABASE_DISABLED: true
          NEXTAUTH_URL: http://localhost:3001
          NEXTAUTH_SECRET: UDQ0C5vC8y9LpuALAFij+g7LzQWlkXCd6jiwNJtcI6g=

      - name: Cleanup Contract Enforcement
        if: always()
        run: |
          echo "üõë Enforcing cleanup contract..."
          
          if [ -n "$SERVER_PID" ]; then
            echo "Stopping server (PID: $SERVER_PID)"
            kill $SERVER_PID 2>/dev/null || true
            
            # Verify process is dead
            sleep 1
            if kill -0 $SERVER_PID 2>/dev/null; then
              echo "‚ö†Ô∏è  Process still alive, forcing kill..."
              kill -9 $SERVER_PID 2>/dev/null || true
            fi
          fi
          
          # Fallback: sweep port 3001
          npx kill-port 3001 || true
          
          # Verify port is free
          if lsof -ti:3001 >/dev/null 2>&1; then
            echo "‚ùå CLEANUP CONTRACT VIOLATION: Port 3001 still occupied."
            lsof -ti:3001 | xargs kill -9 || true
          fi
          
          echo "‚úÖ Cleanup complete. No orphaned processes."

      - name: Upload Test Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-${{ matrix.project }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  governance-report:
    name: üìä CI Governance Summary
    needs: [pre-flight, build, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate Pipeline Conclusion
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'Pre-flight': '${{ needs.pre-flight.result }}',
              'Build': '${{ needs.build.result }}',
              'E2E Tests': '${{ needs.test.result }}'
            };
            
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('CI GOVERNANCE REPORT');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.table(results);
            
            const allPassed = Object.values(results).every(r => r === 'success');
            const anyFailed = Object.values(results).some(r => r === 'failure');
            
            if (anyFailed) {
              const failedJobs = Object.entries(results)
                .filter(([_, status]) => status === 'failure')
                .map(([job, _]) => job);
              
              core.setFailed(
                `CI Governance: Contract violations detected in: ${failedJobs.join(', ')}`
              );
            } else if (allPassed) {
              console.log('‚úÖ All CI contracts satisfied.');
            } else {
              console.log('‚ö†Ô∏è  Some jobs were skipped or cancelled.');
            }
            
            const summary = `
            # CI Governance Report
            
            **Status**: ${allPassed ? '‚úÖ PASS' : '‚ùå FAIL'}
            
            ## Contract Enforcement
            
            | Contract | Status |
            |----------|--------|
            | Pre-flight Validation | ${results['Pre-flight'] === 'success' ? '‚úÖ' : '‚ùå'} |
            | Build Contract | ${results['Build'] === 'success' ? '‚úÖ' : '‚ùå'} |
            | E2E Test Execution | ${results['E2E Tests'] === 'success' ? '‚úÖ' : '‚ùå'} |
            
            ${anyFailed ? '‚ö†Ô∏è **Action Required**: Review failed jobs above.' : ''}
            `;
            
            core.summary.addRaw(summary).write();
